#!/usr/bin/env ansible-playbook
---
- name: Plex machine
  hosts:
    - puppet.local
  remote_user: plex
  vars:
    commands:
      - libaacs
      - libbdplus
      - libbluray
      - libdvdcss
    applications:
      - handbrake
      - makemkv
      - plex
      - plex-media-server
      - vlc
  tasks:
    - name: Create plex user
      become: yes
      user:
        name: plex
        shell: /bin/zsh
    - name: Install commands
      package:
        name: '{{ commands }}'
        state: present
    - name: Install applications
      package:
        name: '{{ applications }}'
        state: latest
        use: homebrew_cask
    - name: Link AACS library for Handbrake
      file:
        src: /Applications/MakeMKV.app/Contents/lib/libmmbd_new.dylib
        dest: ~/lib/libaacs.dylib
        state: link
    - name: Link BBD+ library for Handbrake
      file:
        src: /Applications/MakeMKV.app/Contents/lib/libmmbd_new.dylib
        dest: ~/lib/libbdplus.dylib
        state: link
- name: Ansible
  hosts:
    - puppet.local
  tasks:
    - name: Ensure Ansible can be run on Windows machines from shell
      lineinfile:
        path: ~/.zshenv
        regexp: '^OBJC_DISABLE_INITIALIZE_FORK_SAFETY='
        line: OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES
    - name: Ensure Ansible can be run on Windows machines from cron
      cron:
        env: yes
        name: OBJC_DISABLE_INITIALIZE_FORK_SAFETY
        job: 'YES'
    - name: Ensure Ansible runs every hour
      cron:
        name: ~/ansible/plex.yml
        user: plex
        job: ansible-playbook ~/ansible/plex.yml >> /dev/null 2>&1
        minute: '0'
        state: present

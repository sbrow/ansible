#!/usr/bin/env ansible-playbook
---
- name: Setup Plex Media Server
  hosts:
    - plex.local
  remote_user: plex
  vars:
    commands:
      - libaacs
      - libbdplus
      - libbluray
      - libdvdcss
    applications:
      - handbrake
      - makemkv
      - plex
      - plex-media-server
      - vlc
  tasks:
    - name: Create plex user
      become: yes
      user:
        name: plex
        shell: /bin/zsh
    - name: Untap loginitems
      homebrew_tap:
        name: OJFord/formulae
        state: absent
    - name: Install commands
      package:
        name: '{{ commands }}'
        state: present
    - name: Install applications
      package:
        name: '{{ applications }}'
        state: latest
        use: homebrew_cask
    - name: Link AACS library for Handbrake
      file:
        src: /Applications/MakeMKV.app/Contents/lib/libmmbd_new.dylib
        dest: ~/lib/libaacs.dylib
        state: link
    - name: Link BBD+ library for Handbrake
      file:
        src: /Applications/MakeMKV.app/Contents/lib/libmmbd_new.dylib
        dest: ~/lib/libbdplus.dylib
        state: link
    - name: Add Plex Media Server to the Login Items and hide it.
      command:
        cmd: 'osascript -e ''tell application "System Events" to make login item at end with properties {name: "Plex Media Server",path:"/Applications/Plex Media Server.app", hidden:true}'''
      tags:
        - butt
- name: Setup Ansible
  hosts:
    - plex.local
  tasks:
    - name: Ensure Ansible can be run on on demand on Windows
      lineinfile:
        path: ~/.zshenv
        line: export OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES
        state: present
        create: yes
        regexp: '^(export )?OBJC_DISABLE_INITIALIZE_FORK_SAFETY='
    - name: Use smart gathering in ansible
      lineinfile:
        path: /etc/ansible/ansible.config
        line: gathering = smart
        state: present
        create: yes
        regexp: '#?gathering = (smart|implicit|explicit)'
      become: yes
    - name: Ensure Ansible can run periodically on Windows
      cron:
        env: yes
        name: OBJC_DISABLE_INITIALIZE_FORK_SAFETY
        job: 'YES'
    - name: Make sure Ansible doesn't run plex.yml on cron.
      cron:
        name: ~/ansible/plex.yml
        user: plex
        job: ansible-playbook ~/ansible/plex.yml >> /dev/null 2>&1
        minute: '0'
        state: absent
    - name: Ensure Ansible runs every hour
      cron:
        name: ~/ansible/site.yml
        user: plex
        job: ansible-playbook ~/ansible/site.yml >> /dev/null 2>&1
        minute: '0'
        state: present
